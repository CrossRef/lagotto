<div class="row work-page">
  <div class="col-md-9">
    <div class="panel panel-default">
      <div class="panel-body">
        <% if can?(:manage, Work) && (controller.action_name == "edit" || (controller.action_name == "update" && !@work.errors.empty?)) %>
          <%= simple_form_for @work, :url => work_path(@work), :html => { :role => "form", :remote => true } do |f| %>
            <%= f.input :title, :input_html => { :rows => 2 } %>
            <%= f.input :doi, :label => 'DOI' %>
            <%= f.input :canonical_url, :label => 'Canonical URL' %>
            <%= f.input :pmid, :label => 'PubMed' %>
            <%= f.input :pmcid, :label => 'PubMed Central' %>
            <%= f.input :wos, :label => 'ArXiV' %>
            <%= f.input :wos, :label => 'Web of Science' %>
            <%= f.input :scp, :label => 'Scopus' %>
            <%= f.input :ark, :label => 'Ark' %>
            <%= f.input :dataone, :label => 'DataONE' %>
            <%= f.input :tracked, :as => :boolean, hint: "Collect metrics for this work" %>
            <%= f.association :work_type, collection: WorkType.order("title").map { |work_type| [work_type.title, work_type.id] }, :include_blank => false %>
            <%= f.input :published_on, label: "Publication Date" do %>
              <%= f.input_field :day, as: :day %>
              <%= f.input_field :month, as: :month %>
              <%= f.input_field :year, as: :year %>
            <% end %>

            <div class="form-group pull-right">
              <%= f.submit "Save ", class: "btn btn-default" %>
              <%= link_to 'Cancel', work_path(@work), { :remote => true, :class => 'btn' } %>
            </div>
          <% end %>
        <% else %>
          <h4 class="work"><%= @work.title.html_safe %></h4>
          <% if @work.author.present? %>
            <div class="author"><%= author_format(@work.author).html_safe %></div>
          <% end %>
          <div class="metadata"><%= metadata_format(@work).html_safe %></div>
        <% end %>
      </div>
      <% if can?(:manage, Work) && controller.action_name != "edit" && !(controller.action_name == "update" && !@work.errors.empty?) %>
        <div class="panel-footer">
          <%= icon("external-link") %>
          <%= link_to @work.pid, @work.pid %>
          <div class="btn-group btn-group-sm pull-right" role="group">
            <%= link_to icon("pencil").html_safe, edit_work_path(@work), { :remote => true, :class => 'btn btn-default' } %>
            <%= link_to icon("trash").html_safe, work_path(@work), :data => { :confirm => 'Are you sure?' }, :method => :delete, :class => 'btn btn-default' %>
          </div>
        </div>
      <% end %>
    </div>

    <% if can?(:read, Notification) %>
      <div id="notification-error-message">
        <%= render :partial => 'notification_message' %>
      </div>
    <% end %>
  </div>
  <div class="col-md-3">
    <div class="panel facets">
      <div class="panel-body metadata">
        <% if publishers.length > 1 && @work.publisher_id %>
          <h5>Publisher</h5>
          <div class="publisher"><%= link_to h(@work.publisher.title), publisher_path(@work.publisher.name) %></div>
        <% end %>
        <% if @work.doi.present? %>
          <h5>DOI</h5>
          <dd class="doi" %><%= link_to h(@work.pid), @work.pid %></div>
        <% end %>
        <% if @work.canonical_url.present? %>
          <h5>Canonical URL</h5>
          <dd><%= link_to h(@work.canonical_url), @work.canonical_url %></div>
        <% end %>
        <% if @work.pmid.present? %>
          <h5>PubMed</h5>
          <div id="pmid" data-pmid="<%= @work.pmid %>"><%= link_to @work.pmid_as_url(@work.pmid), @work.pmid_as_url(@work.pmid) %></div>
        <% end %>
        <% if @work.pmcid.present? %>
          <h5>PubMed Central</h5>
          <div id="pmcid" data-pmcid="<%= @work.pmcid %>"><%= link_to @work.pmcid_as_url(@work.pmcid), @work.pmcid_as_url(@work.pmcid) %></div>
        <% end %>
        <% if @work.pmid.present? %>
          <h5>Europe PMC</h5>
          <div><%= link_to h(@work.pmid_as_europepmc_url), @work.pmid_as_europepmc_url %></div>
        <% end %>
        <% if @work.wos.present? && @work.wos_url.present? %>
          <h5>Web of Science</h5>
          <div><%= link_to @work.wos, @work.wos_url %></div>
        <% end %>
        <% if @work.scp.present? && @work.scopus_url.present? %>
          <h5>Scopus</h5>
          <div><%= link_to @work.scp, @work.scopus_url %></div>
        <% end %>
        <% if @work.ark.present? %>
          <h5>Ark</h5>
          <div><%= link_to @work.ark, @work.ark_as_url(@work.ark) %></div>
        <% end %>
        <% if @work.dataone.present? %>
          <h5>DataONE</h5>
          <div><%= link_to @work.dataone, @work.dataone_as_url(@work.dataone) %></div>
        <% end %>
        <% if @work.mendeley_url.present? %>
          <h5>Mendeley</h5>
          <div><%= link_to @work.mendeley_url, @work.mendeley_url %></div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<% if can?(:read, Notification) || @active.present? %>
  <ul class="nav nav-pills">
    <% @active.each_with_index do |tab, i| %>
      <% if i > 0 %>
        <li><a href="#<%= tab %>" data-toggle="tab" title="<%= tab.humanize %>"><%= tab.humanize %></a></li>
      <% else %>
        <li class="active"><a href="#<%= tab %>" data-toggle="tab" title="<%= tab.humanize %>"><%= tab.humanize %></a></li>
      <% end %>
    <% end %>

    <% if can?(:read, Notification) %>
      <% if @active.size > 0 %>
        <li><a href="#recommendations" data-toggle="tab" title="Recommendations">Recommendations</a></li>
      <% else %>
        <li class="active"><a href="#recommendations" data-toggle="tab" title="Recommendations">Recommendations</a></li>
      <% end %>
      <li><a href="#notification" data-toggle="tab" title="Notifications">Notifications</a></li>
    <% end %>
  </ul>

  <div class="tab-content">
    <% @active.each_with_index do |tab, i| %>
      <div class="tab-pane <%= i > 0 ? '' : ' active' %>" id="<%= tab %>">
        <%= render :partial => tab %>
      </div>
    <% end %>

    <% if can?(:read, Notification) %>
      <% if @active.size > 0 %>
        <div class="tab-pane" id="recommendations">
      <% else %>
        <div class="tab-pane active" id="recommendations">
      <% end %>
        <%= render :partial => 'recommendations' %>
      </div>
      <div class="tab-pane" id="notification">
        <%= render :partial => 'notification' %>
      </div>
    <% end %>
  </div>
<% end %>
